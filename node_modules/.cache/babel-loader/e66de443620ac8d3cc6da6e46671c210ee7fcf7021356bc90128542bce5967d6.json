{"ast":null,"code":"// CSRæœç´¢é¡µé¢\nimport React,{useState,useEffect}from'react';import{useAuth}from'../../context/AuthContext';import{useLanguage}from'../../context/LanguageContext';import{DataService}from'../../services/dataService';import Navbar from'../../components/Layout/Navbar';import RequestDetailModal from'../../components/PIN/RequestDetailModal';import'../../styles/search.css';import'../../styles/modern-dashboard.css';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const CSRSearch=()=>{var _user$name;const{user}=useAuth();const{t}=useLanguage();const[requests,setRequests]=useState([]);const[filteredRequests,setFilteredRequests]=useState([]);const[searchTerm,setSearchTerm]=useState('');const[selectedCategory,setSelectedCategory]=useState('');const[selectedUrgency,setSelectedUrgency]=useState('');const[showRequestDetail,setShowRequestDetail]=useState(null);const[shortlistedRequests,setShortlistedRequests]=useState([]);const[categories,setCategories]=useState([]);const[showRejectModal,setShowRejectModal]=useState(false);const[rejectingRequest,setRejectingRequest]=useState(null);const[rejectReason,setRejectReason]=useState('');// åŠ è½½æ‰€æœ‰è¯·æ±‚å’Œæ”¶è—å¤¹\nuseEffect(()=>{let isMounted=true;// é˜²æ­¢ç»„ä»¶å¸è½½åæ›´æ–°çŠ¶æ€\nconst loadData=async()=>{try{// ä¸è°ƒç”¨initializeDataï¼Œå› ä¸ºå®ƒä¼šé‡å¤è¯·æ±‚æ•°æ®\n// ç›´æ¥è·å–æ‰€éœ€æ•°æ®\n// è·å–æ‰€æœ‰å¾…å¤„ç†çš„è¯·æ±‚\nconst allRequests=await DataService.getRequests();if(!isMounted)return;// è¿‡æ»¤å‡ºå¾…å¤„ç†ä¸”æœªè¢«å½“å‰ç”¨æˆ·æ‹’ç»çš„è¯·æ±‚\nconst pendingRequests=(allRequests||[]).filter(request=>{var _request$rejectedVolu;if(request.status!=='pending')return false;// æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²æ‹’ç»æ­¤è¯·æ±‚\nconst rejected=(_request$rejectedVolu=request.rejectedVolunteers)===null||_request$rejectedVolu===void 0?void 0:_request$rejectedVolu.some(r=>{var _r$volunteer;return r.volunteer===(user===null||user===void 0?void 0:user.id)||((_r$volunteer=r.volunteer)===null||_r$volunteer===void 0?void 0:_r$volunteer.id)===(user===null||user===void 0?void 0:user.id);});return!rejected;});setRequests(pendingRequests);setFilteredRequests(pendingRequests);// åŠ è½½åˆ†ç±»æ•°æ®\nconst allCategories=await DataService.getCategories();if(!isMounted)return;setCategories(allCategories||[]);// åŠ è½½ç”¨æˆ·çš„æ”¶è—å¤¹\nif(user!==null&&user!==void 0&&user.id){const savedShortlist=localStorage.getItem(\"shortlist_\".concat(user.id));const userShortlists=savedShortlist?JSON.parse(savedShortlist):[];setShortlistedRequests(userShortlists);}}catch(error){console.error('åŠ è½½æ•°æ®å¤±è´¥:',error);if(!isMounted)return;setRequests([]);setFilteredRequests([]);setShortlistedRequests([]);setCategories([]);}};loadData();// æ¸…ç†å‡½æ•°\nreturn()=>{isMounted=false;};},[user===null||user===void 0?void 0:user.id]);// æœç´¢å’Œè¿‡æ»¤é€»è¾‘\nuseEffect(()=>{const filters={searchText:searchTerm,category:selectedCategory===''?'all':selectedCategory,urgency:selectedUrgency===''?'all':selectedUrgency};const filtered=DataService.filterRequests(requests,filters);setFilteredRequests(filtered);},[requests,searchTerm,selectedCategory,selectedUrgency]);// å¤„ç†æŸ¥çœ‹è¯·æ±‚è¯¦æƒ…\nconst handleViewDetail=async request=>{setShowRequestDetail(request);// è°ƒç”¨APIè·å–å®Œæ•´è¯¦æƒ…ï¼ˆä¼šè‡ªåŠ¨å¢åŠ æµè§ˆé‡ï¼‰\ntry{await DataService.getRequestById(request.id);// é‡æ–°åŠ è½½è¯·æ±‚åˆ—è¡¨ä»¥æ›´æ–°æµè§ˆé‡\nconst updatedRequests=await DataService.getRequests();const pendingRequests=(updatedRequests||[]).filter(req=>req.status==='pending');setRequests(pendingRequests);}catch(error){console.error('è·å–è¯·æ±‚è¯¦æƒ…å¤±è´¥:',error);}};// å¤„ç†æ·»åŠ /ç§»é™¤æ”¶è—\nconst handleToggleShortlist=request=>{if(!user||!user.id){alert(t('csr.search.loginRequired'));return;}const isShortlisted=shortlistedRequests.some(req=>req.requestId===request.id);let updatedShortlist;if(isShortlisted){// ç§»é™¤æ”¶è—\nupdatedShortlist=shortlistedRequests.filter(req=>req.requestId!==request.id);alert(t('csr.search.removeFromShortlist'));}else{// æ·»åŠ æ”¶è—\nconst shortlistItem={id:Date.now(),userId:user.id,requestId:request.id,request:request,shortlistedAt:new Date().toISOString()};updatedShortlist=[...shortlistedRequests,shortlistItem];alert(t('csr.search.addToShortlist'));}setShortlistedRequests(updatedShortlist);// æ›´æ–°æœ¬åœ°å­˜å‚¨\nlocalStorage.setItem(\"shortlist_\".concat(user.id),JSON.stringify(updatedShortlist));};// æ£€æŸ¥è¯·æ±‚æ˜¯å¦å·²æ”¶è—\nconst isRequestShortlisted=requestId=>{return shortlistedRequests.some(req=>req.requestId===requestId);};// æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç”³è¯·è¯¥è¯·æ±‚\nconst hasUserApplied=request=>{var _request$interestedVo;if(!user||!user.id)return false;// æ£€æŸ¥interestedVolunteersæ•°ç»„ä¸­æ˜¯å¦åŒ…å«å½“å‰ç”¨æˆ·\nreturn((_request$interestedVo=request.interestedVolunteers)===null||_request$interestedVo===void 0?void 0:_request$interestedVo.some(v=>v.id===user.id))||false;};// å¤„ç†ç”³è¯·å¿—æ„¿æœåŠ¡\nconst handleApplyVolunteer=async requestId=>{if(!user||!user.email){alert(t('csr.search.loginRequired'));return;}// è°ƒè¯•ä¿¡æ¯\nconsole.log('Applying for request:',{requestId,idLength:requestId===null||requestId===void 0?void 0:requestId.length,idType:typeof requestId,isValid:/^[0-9a-fA-F]{24}$/.test(requestId)});if(window.confirm(t('csr.search.confirmApply'))){try{// ä½¿ç”¨ä¸“é—¨çš„ç”³è¯·API\nawait DataService.applyForRequest(requestId);// æ›´æ–°æœ¬åœ°çŠ¶æ€ - ä¸ä»åˆ—è¡¨ä¸­ç§»é™¤,å› ä¸ºåªæ˜¯ç”³è¯·è¿˜æœªåŒ¹é…\n// å¯ä»¥é€‰æ‹©åˆ·æ–°æ•°æ®æˆ–æ˜¾ç¤º\"å·²ç”³è¯·\"çŠ¶æ€\nconst updatedRequests=await DataService.getRequests();setRequests(updatedRequests);alert(t('csr.search.applySuccess'));}catch(error){console.error('ç”³è¯·å¿—æ„¿æœåŠ¡æ—¶å‡ºé”™:',error);alert(error.message||t('csr.search.applyError'));}}};const handleCancelApplication=async requestId=>{if(window.confirm(t('csr.search.confirmCancel')||'ç¡®è®¤å–æ¶ˆç”³è¯·ï¼Ÿ')){try{await DataService.cancelApplication(requestId);// åˆ·æ–°è¯·æ±‚åˆ—è¡¨\nconst updatedRequests=await DataService.getRequests();setRequests(updatedRequests);alert(t('csr.search.cancelSuccess')||'å·²å–æ¶ˆç”³è¯·');}catch(error){console.error('å–æ¶ˆç”³è¯·æ—¶å‡ºé”™:',error);alert(error.message||t('csr.search.cancelError')||'å–æ¶ˆç”³è¯·å¤±è´¥');}}};// æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²æ‹’ç»è¯¥è¯·æ±‚\nconst hasUserRejected=request=>{var _request$rejectedVolu2;if(!user||!user.id)return false;return((_request$rejectedVolu2=request.rejectedVolunteers)===null||_request$rejectedVolu2===void 0?void 0:_request$rejectedVolu2.some(r=>{var _r$volunteer2;return r.volunteer===user.id||((_r$volunteer2=r.volunteer)===null||_r$volunteer2===void 0?void 0:_r$volunteer2.id)===user.id;}))||false;};// æ‰“å¼€æ‹’ç»æ¨¡æ€æ¡†\nconst handleOpenRejectModal=request=>{setRejectingRequest(request);setRejectReason('');setShowRejectModal(true);};// æ‹’ç»è¯·æ±‚\nconst handleRejectRequest=async()=>{if(!rejectingRequest)return;try{await DataService.rejectRequest(rejectingRequest.id,rejectReason);// åˆ·æ–°è¯·æ±‚åˆ—è¡¨å¹¶è¿‡æ»¤æ‰è¢«æ‹’ç»çš„è¯·æ±‚\nconst updatedRequests=await DataService.getRequests();const pendingRequests=(updatedRequests||[]).filter(req=>req.status==='pending'&&!hasUserRejected(req));setRequests(pendingRequests);setFilteredRequests(pendingRequests);alert(t('csr.search.rejectSuccess'));setShowRejectModal(false);setRejectingRequest(null);setRejectReason('');}catch(error){console.error('æ‹’ç»è¯·æ±‚æ—¶å‡ºé”™:',error);alert(error.message||t('csr.search.rejectError'));}};return/*#__PURE__*/_jsxs(\"div\",{className:\"modern-admin-container\",children:[/*#__PURE__*/_jsx(Navbar,{userType:\"csr\",user:user}),/*#__PURE__*/_jsx(\"div\",{className:\"modern-main-content\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"dashboard\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"modern-dashboard-header\",children:/*#__PURE__*/_jsx(\"div\",{className:\"header-background\",children:/*#__PURE__*/_jsx(\"div\",{className:\"header-content\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"modern-header-content\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"modern-header-left\",children:[/*#__PURE__*/_jsx(\"h1\",{className:\"modern-header-title\",children:t('csr.search.title')}),/*#__PURE__*/_jsx(\"p\",{className:\"modern-header-subtitle\",children:t('csr.search.subtitle')})]}),/*#__PURE__*/_jsx(\"div\",{className:\"modern-header-avatar\",children:/*#__PURE__*/_jsx(\"div\",{className:\"modern-avatar-container\",children:user!==null&&user!==void 0&&user.avatar?/*#__PURE__*/_jsx(\"img\",{src:user.avatar,alt:user.name}):(user===null||user===void 0?void 0:(_user$name=user.name)===null||_user$name===void 0?void 0:_user$name.charAt(0).toUpperCase())||'ğŸ¯'})})]})})})}),/*#__PURE__*/_jsx(\"div\",{className:\"modern-card\",style:{marginBottom:'2rem'},children:/*#__PURE__*/_jsx(\"div\",{className:\"card-content\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"search-filters\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"search-bar\",children:/*#__PURE__*/_jsx(\"input\",{type:\"text\",placeholder:t('csr.search.searchPlaceholder'),value:searchTerm,onChange:e=>setSearchTerm(e.target.value),className:\"form-input\",style:{flex:1}})}),/*#__PURE__*/_jsxs(\"div\",{className:\"filter-row\",style:{display:'flex',gap:'1rem',marginTop:'1rem'},children:[/*#__PURE__*/_jsxs(\"select\",{value:selectedCategory,onChange:e=>setSelectedCategory(e.target.value),className:\"form-select\",children:[/*#__PURE__*/_jsx(\"option\",{value:\"\",children:t('csr.search.allCategories')}),categories.map(category=>/*#__PURE__*/_jsx(\"option\",{value:category.id,children:t(category.name)},category.id))]}),/*#__PURE__*/_jsxs(\"select\",{value:selectedUrgency,onChange:e=>setSelectedUrgency(e.target.value),className:\"form-select\",children:[/*#__PURE__*/_jsx(\"option\",{value:\"\",children:t('csr.search.allUrgency')}),DataService.getUrgencyLevels().map(urgency=>/*#__PURE__*/_jsx(\"option\",{value:urgency.id,children:t(urgency.name)},urgency.id))]})]})]})})}),/*#__PURE__*/_jsxs(\"div\",{className:\"modern-stats-grid\",style:{marginBottom:'2rem'},children:[/*#__PURE__*/_jsxs(\"div\",{className:\"modern-stat-card info\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"stat-content\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"stat-header\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"stat-icon\",children:\"\\uD83D\\uDD0D\"}),/*#__PURE__*/_jsx(\"div\",{className:\"stat-trend\",children:\"\\uD83D\\uDCC8\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"stat-body\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"stat-value\",children:filteredRequests.length}),/*#__PURE__*/_jsx(\"div\",{className:\"stat-title\",children:t('stats.availableOpportunities')})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"stat-glow\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"modern-stat-card warning\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"stat-content\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"stat-header\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"stat-icon\",children:\"\\uD83D\\uDEA8\"}),/*#__PURE__*/_jsx(\"div\",{className:\"stat-trend\",children:\"\\uD83D\\uDCC8\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"stat-body\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"stat-value\",children:filteredRequests.filter(r=>r.urgency==='urgent').length}),/*#__PURE__*/_jsx(\"div\",{className:\"stat-title\",children:t('stats.urgentRequests')})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"stat-glow\"})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"modern-card main-card\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"card-header\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"card-title\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"card-icon\",children:\"\\uD83C\\uDFAF\"}),/*#__PURE__*/_jsx(\"h3\",{children:t('csr.search.opportunities')})]}),/*#__PURE__*/_jsx(\"div\",{className:\"card-subtitle\",children:t('csr.search.opportunitiesDesc')})]}),/*#__PURE__*/_jsx(\"div\",{className:\"card-content\",children:filteredRequests.length>0?/*#__PURE__*/_jsx(\"div\",{className:\"request-list\",children:filteredRequests.map(request=>{var _request$location;return/*#__PURE__*/_jsxs(\"div\",{className:\"request-item\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"request-header\",children:[/*#__PURE__*/_jsx(\"h4\",{className:\"request-title\",children:request.title}),/*#__PURE__*/_jsx(\"div\",{className:\"urgency-badge \".concat(request.urgency),children:t(DataService.getUrgencyById(request.urgency).name)})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"request-meta\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"category-tag\",children:t(DataService.getCategoryById(request.category).name)}),/*#__PURE__*/_jsxs(\"span\",{className:\"meta-item\",children:[\"\\uD83D\\uDCCD \",((_request$location=request.location)===null||_request$location===void 0?void 0:_request$location.address)||request.location||'å¾…ç¡®å®š']}),/*#__PURE__*/_jsxs(\"span\",{className:\"meta-item\",children:[\"\\uD83D\\uDC64 \",request.requesterName]}),/*#__PURE__*/_jsx(\"span\",{className:\"meta-item\",children:DataService.getTimeAgo(request.createdAt,t)})]}),/*#__PURE__*/_jsx(\"div\",{className:\"request-description\",children:request.description}),request.expectedDate&&/*#__PURE__*/_jsxs(\"div\",{className:\"request-timing\",children:[/*#__PURE__*/_jsxs(\"strong\",{children:[t('request.form.expectedDate'),\"\\uFF1A\"]}),new Date(request.expectedDate).toLocaleDateString(),request.expectedTime&&\" \".concat(request.expectedTime)]}),/*#__PURE__*/_jsxs(\"div\",{className:\"request-actions\",children:[hasUserApplied(request)?/*#__PURE__*/_jsxs(\"button\",{className:\"btn btn-danger\",onClick:()=>handleCancelApplication(request.id),children:[\"\\u2717 \",t('csr.search.cancelApplication')||'å–æ¶ˆç”³è¯·']}):/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-primary\",onClick:()=>handleApplyVolunteer(request.id),children:t('csr.search.applyVolunteer')}),/*#__PURE__*/_jsx(\"button\",{className:\"btn \".concat(isRequestShortlisted(request.id)?'btn-warning':'btn-outline'),onClick:()=>handleToggleShortlist(request),children:isRequestShortlisted(request.id)?\"\\u2B50 \".concat(t('csr.search.shortlisted')):\"\\u2606 \".concat(t('csr.search.shortlist'))}),/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-secondary\",onClick:()=>handleViewDetail(request),children:t('csr.search.viewDetails')}),/*#__PURE__*/_jsxs(\"button\",{className:\"btn btn-danger btn-outline\",onClick:()=>handleOpenRejectModal(request),title:t('csr.search.rejectRequest'),children:[\"\\uD83D\\uDEAB \",t('csr.search.rejectRequest')]})]})]},request.id);})}):/*#__PURE__*/_jsxs(\"div\",{className:\"empty-state\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"empty-state-icon\",children:\"\\uD83D\\uDD0D\"}),/*#__PURE__*/_jsx(\"div\",{className:\"empty-state-title\",children:requests.length===0?t('csr.search.noOpportunities'):t('csr.search.noResults')}),/*#__PURE__*/_jsx(\"div\",{className:\"empty-state-description\",children:requests.length===0?t('csr.search.noOpportunitiesDesc'):t('csr.search.noResultsDesc')}),requests.length>0&&/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-secondary\",onClick:()=>{setSearchTerm('');setSelectedCategory('');setSelectedUrgency('');},children:t('csr.search.clearFilters')})]})})]})]})}),showRequestDetail&&/*#__PURE__*/_jsx(RequestDetailModal,{request:showRequestDetail,onClose:()=>setShowRequestDetail(null)}),showRejectModal&&/*#__PURE__*/_jsx(\"div\",{className:\"modal-overlay\",onClick:()=>setShowRejectModal(false),children:/*#__PURE__*/_jsxs(\"div\",{className:\"modal-container\",onClick:e=>e.stopPropagation(),children:[/*#__PURE__*/_jsxs(\"div\",{className:\"modal-header\",children:[/*#__PURE__*/_jsxs(\"h2\",{children:[\"\\uD83D\\uDEAB \",t('csr.search.rejectRequest')]}),/*#__PURE__*/_jsx(\"button\",{className:\"modal-close\",onClick:()=>setShowRejectModal(false),children:\"\\u2715\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"modal-body\",children:[/*#__PURE__*/_jsx(\"p\",{style:{marginBottom:'1rem',color:'#64748b'},children:t('csr.search.confirmReject')}),rejectingRequest&&/*#__PURE__*/_jsxs(\"div\",{style:{padding:'1rem',background:'#f8fafc',borderRadius:'8px',marginBottom:'1rem'},children:[/*#__PURE__*/_jsx(\"strong\",{children:rejectingRequest.title}),/*#__PURE__*/_jsx(\"div\",{style:{fontSize:'0.875rem',color:'#64748b',marginTop:'0.5rem'},children:t(DataService.getCategoryById(rejectingRequest.category).name)})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"form-group\",children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"rejectReason\",children:t('csr.search.rejectReason')}),/*#__PURE__*/_jsx(\"textarea\",{id:\"rejectReason\",className:\"form-textarea\",rows:\"4\",value:rejectReason,onChange:e=>setRejectReason(e.target.value),placeholder:t('csr.search.rejectReasonPlaceholder'),maxLength:\"500\"}),/*#__PURE__*/_jsxs(\"div\",{style:{fontSize:'0.875rem',color:'#94a3b8',marginTop:'0.25rem'},children:[rejectReason.length,\"/500\"]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"modal-footer\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-secondary\",onClick:()=>setShowRejectModal(false),children:\"\\u53D6\\u6D88\"}),/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-danger\",onClick:handleRejectRequest,children:\"\\uD83D\\uDEAB \\u786E\\u8BA4\\u62D2\\u7EDD\"})]})]})})]});};// ç¡¬ç¼–ç å‡½æ•°å·²ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨DataServiceå’Œå›½é™…åŒ–\nexport default CSRSearch;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}