{"ast":null,"code":"import React,{useState,useEffect}from'react';import{useNavigate}from'react-router-dom';import{useAuth}from'../../context/AuthContext';import{useLanguage}from'../../context/LanguageContext';import Navbar from'../../components/Layout/Navbar';import apiService from'../../services/apiService';import{isSystemAdmin}from'../../utils/permissions';import'../../styles/user-management.css';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const UserManagement=()=>{const navigate=useNavigate();const{user}=useAuth();const{t}=useLanguage();const[users,setUsers]=useState([]);const[filteredUsers,setFilteredUsers]=useState([]);const[filterType,setFilterType]=useState('all');const[searchTerm,setSearchTerm]=useState('');const[selectedUser,setSelectedUser]=useState(null);const[showUserDetail,setShowUserDetail]=useState(false);useEffect(()=>{if(!isSystemAdmin(user)){alert(t('permission.denied')||'Access Denied: System Admin only');navigate('/admin/dashboard');}},[user,navigate,t]);// 格式化日期的辅助函数\nconst formatDate=dateString=>{if(!dateString)return'N/A';try{return new Date(dateString).toLocaleDateString('zh-CN');}catch(error){return'N/A';}};const handleGoBack=()=>{navigate(-1);// 返回上一页\n};// 加载用户数据\nuseEffect(()=>{loadUsers();},[]);// 过滤用户\nuseEffect(()=>{let filtered=users;// 按用户类型过滤\nif(filterType!=='all'){filtered=filtered.filter(user=>user.userType===filterType);}// 按搜索词过滤\nif(searchTerm){filtered=filtered.filter(user=>user.name.toLowerCase().includes(searchTerm.toLowerCase())||user.email.toLowerCase().includes(searchTerm.toLowerCase()));}setFilteredUsers(filtered);},[users,filterType,searchTerm]);// 获取用户的请求数量\nconst getUserRequestCount=(userId,userEmail)=>{const allRequests=JSON.parse(localStorage.getItem('userRequests')||'[]');return allRequests.filter(req=>req.requesterId===userId||req.requesterEmail===userEmail).length;};const loadUsers=async()=>{try{// 从API获取最新的用户数据\nconst apiUsers=await apiService.getAllUsers();// 转换MongoDB数据格式到前端需要的格式\nconst formattedUsers=apiUsers.map(user=>({id:user._id,name:user.name,email:user.email,userType:user.userType,phone:user.phone,address:user.address,organization:user.organization,skills:user.skills,status:user.status,createdAt:user.createdAt,lastLogin:user.lastLogin,loginCount:user.loginCount}));// 过滤掉管理员用户\nconst nonAdminUsers=formattedUsers.filter(u=>u.userType!=='admin');setUsers(nonAdminUsers);// 同时更新localStorage以保持兼容性\nlocalStorage.setItem('registeredUsers',JSON.stringify(nonAdminUsers));}catch(error){console.error('加载用户数据失败:',error);// 如果API调用失败，回退到localStorage\nconst registeredUsers=JSON.parse(localStorage.getItem('registeredUsers')||'[]');setUsers(registeredUsers.filter(u=>u.userType!=='admin'));}};const handleDeleteUser=async userId=>{// 首先获取要删除的用户信息\nconst userToDelete=users.find(u=>u.id===userId);let confirmMessage=t('admin.users.confirmDelete');if(window.confirm(confirmMessage)){try{// 使用API删除用户（实际上是设置状态为deleted）\nawait apiService.batchUpdateUsers('delete',[userId]);// 重新加载用户列表以获取最新状态\nawait loadUsers();alert(t('admin.users.deleteSuccess'));}catch(error){console.error('删除用户失败:',error);alert('删除用户失败，请稍后重试');}}};const handleToggleUserStatus=async userId=>{const user=users.find(u=>u.id===userId);if(!user)return;const newStatus=user.status==='active'?'suspended':'active';const action=newStatus==='active'?'activate':'suspend';try{// 使用API更新用户状态\nawait apiService.batchUpdateUsers(action,[userId]);// 重新加载用户列表以获取最新状态\nawait loadUsers();const statusText=newStatus==='active'?'激活':'暂停';alert(\"\\u7528\\u6237\\u5DF2\".concat(statusText));}catch(error){console.error('更新用户状态失败:',error);alert('更新用户状态失败，请稍后重试');}};const getUserTypeColor=userType=>{switch(userType){case'pin':return'user-type-pin';case'csr':return'user-type-csr';default:return'user-type-default';}};const getStatusColor=status=>{return status==='active'?'status-active':'status-suspended';};return/*#__PURE__*/_jsxs(\"div\",{className:\"page-container\",children:[/*#__PURE__*/_jsx(Navbar,{userType:\"admin\",user:user}),/*#__PURE__*/_jsx(\"div\",{className:\"main-content\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"user-management\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"page-header\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"page-nav\",children:/*#__PURE__*/_jsxs(\"button\",{className:\"btn btn-back\",onClick:handleGoBack,title:t('common.back')||'返回',children:[/*#__PURE__*/_jsx(\"span\",{className:\"btn-icon\",children:\"\\u2190\"}),t('common.back')||'返回']})}),/*#__PURE__*/_jsxs(\"div\",{className:\"header-content\",children:[/*#__PURE__*/_jsx(\"h1\",{className:\"page-title\",children:t('admin.users.title')}),/*#__PURE__*/_jsx(\"p\",{className:\"page-subtitle\",children:t('admin.users.subtitle')})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"header-stats\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"stat-item\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"stat-value\",children:users.length}),/*#__PURE__*/_jsx(\"span\",{className:\"stat-label\",children:t('admin.users.totalUsers')})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"stat-item\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"stat-value\",children:users.filter(u=>u.userType==='pin').length}),/*#__PURE__*/_jsxs(\"span\",{className:\"stat-label\",children:[\"PIN \",t('admin.users.users')]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"stat-item\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"stat-value\",children:users.filter(u=>u.userType==='csr').length}),/*#__PURE__*/_jsxs(\"span\",{className:\"stat-label\",children:[\"CSR \",t('admin.users.users')]})]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"filters-section\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"search-box\",children:/*#__PURE__*/_jsx(\"input\",{type:\"text\",placeholder:t('admin.users.searchPlaceholder'),value:searchTerm,onChange:e=>setSearchTerm(e.target.value),className:\"search-input\"})}),/*#__PURE__*/_jsxs(\"div\",{className:\"filter-buttons\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"filter-btn \".concat(filterType==='all'?'active':''),onClick:()=>setFilterType('all'),children:t('admin.users.allUsers')}),/*#__PURE__*/_jsxs(\"button\",{className:\"filter-btn \".concat(filterType==='pin'?'active':''),onClick:()=>setFilterType('pin'),children:[\"PIN \",t('admin.users.users')]}),/*#__PURE__*/_jsxs(\"button\",{className:\"filter-btn \".concat(filterType==='csr'?'active':''),onClick:()=>setFilterType('csr'),children:[\"CSR \",t('admin.users.users')]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"users-table-container\",children:[/*#__PURE__*/_jsxs(\"table\",{className:\"users-table\",children:[/*#__PURE__*/_jsx(\"thead\",{children:/*#__PURE__*/_jsxs(\"tr\",{children:[/*#__PURE__*/_jsx(\"th\",{children:t('admin.users.name')}),/*#__PURE__*/_jsx(\"th\",{children:t('admin.users.email')}),/*#__PURE__*/_jsx(\"th\",{children:t('admin.users.userType')}),/*#__PURE__*/_jsx(\"th\",{children:t('admin.users.status')}),/*#__PURE__*/_jsx(\"th\",{children:t('admin.users.requestCount')}),/*#__PURE__*/_jsx(\"th\",{children:t('admin.users.joinDate')}),/*#__PURE__*/_jsx(\"th\",{children:t('admin.users.lastLogin')}),/*#__PURE__*/_jsx(\"th\",{children:t('admin.users.actions')})]})}),/*#__PURE__*/_jsx(\"tbody\",{children:filteredUsers.map(user=>/*#__PURE__*/_jsxs(\"tr\",{children:[/*#__PURE__*/_jsx(\"td\",{children:/*#__PURE__*/_jsxs(\"div\",{className:\"user-info\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"user-avatar\",children:user.name.charAt(0).toUpperCase()}),/*#__PURE__*/_jsxs(\"div\",{className:\"user-details\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"user-name\",children:user.name}),/*#__PURE__*/_jsx(\"div\",{className:\"user-phone\",children:user.phone||'N/A'})]})]})}),/*#__PURE__*/_jsx(\"td\",{children:user.email}),/*#__PURE__*/_jsx(\"td\",{children:/*#__PURE__*/_jsx(\"span\",{className:\"user-type-badge \".concat(getUserTypeColor(user.userType)),children:user.userType==='pin'?'PIN':'CSR'})}),/*#__PURE__*/_jsx(\"td\",{children:/*#__PURE__*/_jsx(\"span\",{className:\"status-badge \".concat(getStatusColor(user.status||'active')),children:(user.status||'active')==='active'?t('admin.users.active'):t('admin.users.suspended')})}),/*#__PURE__*/_jsx(\"td\",{children:/*#__PURE__*/_jsx(\"span\",{className:\"request-count\",children:getUserRequestCount(user.id,user.email)})}),/*#__PURE__*/_jsx(\"td\",{children:formatDate(user.createdAt)}),/*#__PURE__*/_jsx(\"td\",{children:formatDate(user.lastLogin)}),/*#__PURE__*/_jsx(\"td\",{children:/*#__PURE__*/_jsxs(\"div\",{className:\"action-buttons\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-sm btn-info\",onClick:()=>{setSelectedUser(user);setShowUserDetail(true);},children:t('admin.users.view')}),/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-sm \".concat((user.status||'active')==='active'?'btn-warning':'btn-success'),onClick:()=>handleToggleUserStatus(user.id),children:(user.status||'active')==='active'?t('admin.users.suspend'):t('admin.users.activate')}),/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-sm btn-danger\",onClick:()=>handleDeleteUser(user.id),children:t('admin.users.delete')})]})})]},user.id))})]}),filteredUsers.length===0&&/*#__PURE__*/_jsxs(\"div\",{className:\"empty-state\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"empty-icon\",children:\"\\uD83D\\uDC65\"}),/*#__PURE__*/_jsx(\"div\",{className:\"empty-title\",children:t('admin.users.noUsers')}),/*#__PURE__*/_jsx(\"div\",{className:\"empty-description\",children:t('admin.users.noUsersDesc')})]})]})]})}),showUserDetail&&selectedUser&&/*#__PURE__*/_jsx(\"div\",{className:\"modal-overlay\",onClick:()=>setShowUserDetail(false),children:/*#__PURE__*/_jsxs(\"div\",{className:\"modal-content\",onClick:e=>e.stopPropagation(),children:[/*#__PURE__*/_jsxs(\"div\",{className:\"modal-header\",children:[/*#__PURE__*/_jsx(\"h3\",{children:t('admin.users.userDetails')}),/*#__PURE__*/_jsx(\"button\",{className:\"modal-close\",onClick:()=>setShowUserDetail(false),children:\"\\xD7\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"modal-body\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"detail-grid\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"detail-item\",children:[/*#__PURE__*/_jsxs(\"label\",{children:[t('admin.users.name'),\":\"]}),/*#__PURE__*/_jsx(\"span\",{children:selectedUser.name})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"detail-item\",children:[/*#__PURE__*/_jsxs(\"label\",{children:[t('admin.users.email'),\":\"]}),/*#__PURE__*/_jsx(\"span\",{children:selectedUser.email})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"detail-item\",children:[/*#__PURE__*/_jsxs(\"label\",{children:[t('admin.users.userType'),\":\"]}),/*#__PURE__*/_jsx(\"span\",{children:selectedUser.userType==='pin'?'PIN':'CSR'})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"detail-item\",children:[/*#__PURE__*/_jsxs(\"label\",{children:[t('admin.users.phone'),\":\"]}),/*#__PURE__*/_jsx(\"span\",{children:selectedUser.phone||'N/A'})]}),selectedUser.userType==='pin'&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(\"div\",{className:\"detail-item\",children:[/*#__PURE__*/_jsxs(\"label\",{children:[t('admin.users.address'),\":\"]}),/*#__PURE__*/_jsx(\"span\",{children:selectedUser.address||'N/A'})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"detail-item\",children:[/*#__PURE__*/_jsxs(\"label\",{children:[t('admin.users.emergencyContact'),\":\"]}),/*#__PURE__*/_jsx(\"span\",{children:selectedUser.emergencyContact||'N/A'})]})]}),selectedUser.userType==='csr'&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(\"div\",{className:\"detail-item\",children:[/*#__PURE__*/_jsxs(\"label\",{children:[t('admin.users.organization'),\":\"]}),/*#__PURE__*/_jsx(\"span\",{children:selectedUser.organization||'N/A'})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"detail-item\",children:[/*#__PURE__*/_jsxs(\"label\",{children:[t('admin.users.skills'),\":\"]}),/*#__PURE__*/_jsx(\"span\",{children:selectedUser.skills?selectedUser.skills.join(', '):'N/A'})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"detail-item\",children:[/*#__PURE__*/_jsxs(\"label\",{children:[t('admin.users.status'),\":\"]}),/*#__PURE__*/_jsx(\"span\",{className:\"status-badge \".concat(getStatusColor(selectedUser.status||'active')),children:(selectedUser.status||'active')==='active'?t('admin.users.active'):t('admin.users.suspended')})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"detail-item\",children:[/*#__PURE__*/_jsxs(\"label\",{children:[t('admin.users.joinDate'),\":\"]}),/*#__PURE__*/_jsx(\"span\",{children:formatDate(selectedUser.createdAt)})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"detail-item\",children:[/*#__PURE__*/_jsxs(\"label\",{children:[t('admin.users.lastLogin'),\":\"]}),/*#__PURE__*/_jsx(\"span\",{children:formatDate(selectedUser.lastLogin)})]})]})})]})})]});};export default UserManagement;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}